<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Service Catalog</h2>
  <button class="btn btn-primary" (click)="openCreateModal()">Add Service</button>
</div>

<div class="mb-4">
  <select class="form-select w-auto" (change)="filterByCategory($event)">
    <option value="">All Categories</option>
    @for (cat of categories; track cat.id) {
    <option [value]="cat.id">{{ cat.name }}</option>
    }
  </select>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Name</th>
        <th>Category</th>
        <th>Price</th>
        <th>SLA (Hours)</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      @for (service of filteredServices; track service.id) {
      <tr>
        <td>{{ service.name }}</td>
        <td>{{ getCategoryName(service.categoryId) }}</td>
        <td>â‚¹{{ service.basePrice | number:'1.2-2' }}</td>
        <td>{{ service.slaHours }}</td>
        <td>{{ service.description }}</td>
        <td>
          <button class="btn btn-sm btn-danger" (click)="deleteService(service.id)">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
      } @empty {
      <tr>
        <td colspan="6" class="text-center">No services found.</td>
      </tr>
      }
    </tbody>
  </table>
</div>

@if (showCreateModal) {
<div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.5); overflow-y: auto;">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Service</h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="createForm">
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" formControlName="categoryId"
              [ngClass]="{'is-invalid': isInvalid('categoryId')}">
              <option value="">Select Category</option>
              @for (cat of categories; track cat.id) {
              <option [value]="cat.id">{{ cat.name }}</option>
              }
            </select>
            @if (isInvalid('categoryId')) {
            <div class="invalid-feedback d-block">Please select a category.</div>
            }
          </div>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" formControlName="name"
              [ngClass]="{'is-invalid': isInvalid('name')}">
            @if (isInvalid('name')) {
            <div class="invalid-feedback d-block">
              @if (createForm.get('name')?.errors?.['required']) {
              Service name is required.
              } @else if (createForm.get('name')?.errors?.['minlength']) {
              Service name must be at least 3 characters long.
              } @else if (createForm.get('name')?.errors?.['alphanumericWithSpaces']) {
              Service name contains invalid characters.
              } @else if (createForm.get('name')?.errors?.['whitespace']) {
              Service name cannot be only spaces.
              }
            </div>
            }
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" formControlName="description" rows="3"
              [ngClass]="{'is-invalid': isInvalid('description')}"></textarea>
            @if (isInvalid('description')) {
            <div class="invalid-feedback d-block">
              @if (createForm.get('description')?.errors?.['required']) {
              Description is required.
              } @else if (createForm.get('description')?.errors?.['minlength']) {
              Description must be at least 10 characters long.
              } @else if (createForm.get('description')?.errors?.['alphanumericWithSpaces']) {
              Description contains invalid characters.
              } @else if (createForm.get('description')?.errors?.['whitespace']) {
              Description cannot be only spaces.
              }
            </div>
            }
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Base Price</label>
              <input type="number" class="form-control" formControlName="basePrice" step="0.01" min="0"
                placeholder="99.99" [ngClass]="{'is-invalid': isInvalid('basePrice')}">
              @if (isInvalid('basePrice')) {
              <div class="invalid-feedback d-block">
                @if (createForm.get('basePrice')?.errors?.['required']) {
                Price is required.
                } @else if (createForm.get('basePrice')?.errors?.['min']) {
                Price must be at least 0.
                } @else if (createForm.get('basePrice')?.errors?.['max']) {
                Price cannot exceed 999,999.
                }
              </div>
              }
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">SLA Hours</label>
              <input type="number" class="form-control" formControlName="slaHours"
                [ngClass]="{'is-invalid': isInvalid('slaHours')}">
              @if (isInvalid('slaHours')) {
              <div class="invalid-feedback d-block">
                @if (createForm.get('slaHours')?.errors?.['required']) {
                SLA hours is required.
                } @else if (createForm.get('slaHours')?.errors?.['min']) {
                SLA must be at least 1 hour.
                } @else if (createForm.get('slaHours')?.errors?.['max']) {
                SLA cannot exceed 720 hours (30 days).
                }
              </div>
              }
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Duration (Mins)</label>
              <input type="number" class="form-control" formControlName="estimatedDurationMinutes"
                [ngClass]="{'is-invalid': isInvalid('estimatedDurationMinutes')}">
              @if (isInvalid('estimatedDurationMinutes')) {
              <div class="invalid-feedback d-block">
                @if (createForm.get('estimatedDurationMinutes')?.errors?.['required']) {
                Duration is required.
                } @else if (createForm.get('estimatedDurationMinutes')?.errors?.['min']) {
                Duration must be at least 1 minute.
                } @else if (createForm.get('estimatedDurationMinutes')?.errors?.['max']) {
                Duration cannot exceed 1440 minutes (24 hours).
                }
              </div>
              }
            </div>
          </div>

          <!-- Images Section -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0">Images</label>
              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="addImage()">
                <i class="bi bi-plus-lg"></i> Add Image
              </button>
            </div>

            <div formArrayName="images">
              @for (img of images.controls; track $index) {
              <div [formGroupName]="$index" class="card p-3 mb-2 bg-light">
                <div class="row align-items-end">
                  <div class="col-md-5">
                    <label class="form-label small">Image URL</label>
                    <input type="text" class="form-control form-control-sm" formControlName="url"
                      placeholder="https://..." [ngClass]="{'is-invalid': isImageInvalid($index, 'url')}">
                    @if (isImageInvalid($index, 'url')) {
                    <div class="invalid-feedback d-block">
                      @if (images.at($index).get('url')?.errors?.['required']) {
                      Image URL is required.
                      } @else if (images.at($index).get('url')?.errors?.['invalidUrl']) {
                      Please enter a valid URL.
                      }
                    </div>
                    }
                  </div>
                  <div class="col-md-5">
                    <label class="form-label small">Alt Text</label>
                    <input type="text" class="form-control form-control-sm" formControlName="alt"
                      placeholder="Description" [ngClass]="{'is-invalid': isImageInvalid($index, 'alt')}">
                    @if (isImageInvalid($index, 'alt')) {
                    <div class="invalid-feedback d-block">
                      @if (images.at($index).get('alt')?.errors?.['required']) {
                      Alt text is required.
                      } @else if (images.at($index).get('alt')?.errors?.['alphanumericWithSpaces']) {
                      Alt text contains invalid characters.
                      } @else if (images.at($index).get('alt')?.errors?.['whitespace']) {
                      Alt text cannot be only spaces.
                      }
                    </div>
                    }
                  </div>
                  <div class="col-md-2 text-end">
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeImage($index)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
              }
            </div>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
        <button type="button" class="btn btn-primary" (click)="createService()"
          [disabled]="createForm.invalid">Save</button>
      </div>
    </div>
  </div>
</div>
}